---
layout: post
title: "浅析基于分离轴原理的碰撞检测及分离算法"
date: 2017-07-15
comments: true
tags: 
	- 游戏
	- 算法
---


# **导言**

分离轴原理（SAT）是一个能用于2d游戏中凸多边形碰撞检测的算法，在自制游戏中我将其作为玩家、怪物、子弹和墙壁碰撞检测及分离的核心算法。

想要实现分离轴原理首先需要有一定的向量知识以及算法实现能力，在实现过程中我自行实现了一个Vector向量类作为基本函数、向量对象的提供者。

以下是个人对这个算法的理解，若有不当之处，还请指正，不胜感激。

> 适用范围： 2D游戏，凸多边形（常见的三角形、四边形等），碰撞检测，分离
>
> 非凸多边形的改进办法：
>
> > 1. 将物体划分成多个凸多边形
> > 2. 将物体看作一个凸多边形，前提是对碰撞检测的精度要求并不高。

<!-- more -->

# **原理介绍**

## **什么是碰撞？**

首先来看这个问题：什么是碰撞？什么才叫发生了碰撞？ 最简单的解释就足够了：两个物体之间没有间隙，或者它们的图像之间有重叠，由此我们可以想到一个最常规的判断方法：光线检测法（自编名词，仅为帮助理解）。

## **光线检测法**

![光线检测法](http://ot1c7ttzm.bkt.clouddn.com/sat1.png)

假设我们手上拿着手电筒，360°绕着这两个物体照射，当有一束光能够从两个物体中间穿过去，那么这两个物体之间就存在间隙，也就是说它们没有发生碰撞。 到此我们可以得到：

> 1. 一个非常简单粗暴的检测方法：枚举360个角度，判断能否找到存在有这么一个角度，有条直线能够从两个物体之间穿过。
> 2. 为什么说这个方法仅适用于凸多边形，如下图，无法找到存在这么一条直线能够从两者之间穿过去，但这两个物体本身并没有发生碰撞。 ![非凸多边形](http://ot1c7ttzm.bkt.clouddn.com/sat2.png)

## **投影**

现在介绍一下一个非常关键的概念，也是整个算法的基础：**投影**。 两个物体未发生碰撞 -> 两个物体之间有空隙 -> 可以找到一条穿过它们中间的一条直线。 那么，**两个物体在垂直这条线的投影轴上的投影也必定存在空隙**。 ![投影1](http://ot1c7ttzm.bkt.clouddn.com/sat3.png)

## **进一步优化**

若要枚举所有角度所有直线，需要大量的时间用于计算，最直接的影响就是游戏卡顿。所幸，这是两个凸多边形，基于多边形的性质，我们可以把检测的角度数量缩减为两个多边形边数之和，也就是这个算法的核心：**以两个凸多边形边的法线作为投影轴，将两个凸多边形投影至投影轴上，判断是否相交。**

# **实现步骤**

1.取第一个凸多边形相邻的两个点，得到向量a

> $$Vector\ \vec{a}=(first.x1-first.x2,first.y1-first.y2)$$

2.求取向量a的法向量b并化为单位向量（为方便求取投影），b即为投影轴

> $$Vector\ \vec{b}=(\frac{-\vec{a}.y}{\sqrt{\vec{a}.y^2+\vec{a}.x^2}},\frac{\vec{a}.x}{\sqrt{\vec{a}.y^2+\vec{a}.x^2}})$$

3.任取第一个多边形上一点，作从原点指向该点的向量c(first.x,first.y)，计算c在b上的投影$$ 投影=|\vec{c}|cos\theta=\frac{\vec{c} \cdot \vec{b}}{|\vec{b}|}=\vec{c} \cdot \vec{b} $$,又因为b已经化为单位向量，因此c在b上的投影就是b和c的点乘值。

以此枚举第一个多边形上所有的点，记录下最大值max1和最小值min1

![投影2](http://ot1c7ttzm.bkt.clouddn.com/sat4.png)

4.同样枚举第二个多边形上所有点，得到最大值max2,最小值min2

5.判断是否碰撞

> - 未发生碰撞
>
> > min2 > max1或 min1 > max2 两者中间有空隙，未发生碰撞
>
> - 发生碰撞（若不需分离可直接跳至下一步）
>
> > - min2 <= max1 分离最小距离与 abs(min2-max1)（此为两物体重叠距离） 比较，保留较小值并保留投影轴方向
> >
> > > 因向量方向任意，因此在计算距离时要记得加上绝对值abs
> >
> > - min1 <= max2 分离最小距离与 abs(min1-max2)（此为两物体重叠距离） 比较，保留较小值并保留投影轴方向

6.只要在任意一轴上检测到没发生碰撞，则可立刻得到未发生碰撞的结论！无需继续检测其它轴。

7.回到步骤1，枚举第一、第二个多边形所有边作为投影轴，重复步骤1-5。

8.得出判断

# **分离**

在检测到碰撞基础上进行分离： 在第五步中我们得到了最小分离距离和投影轴方向，又因为投影轴向量已经单位化，因此向量分别乘以距离即是坐标需要移动的距离，至于分离谁则需要自行根据情况决定。 $$ x-=min \times \vec{bmin}.x; $$ $$ y-=min \times \vec{bmin}.y; $$

(（x，y）为物体中心坐标，bmin为保留的投影轴，min为最小分离距离)

# **圆的碰撞检测及分离**

圆与其它凸多边形又有些许不同，它没有可以用于生成投影轴的边，于是乎我们用圆心和另一个凸多边形距离圆心最近的点的连线作为投影轴，再结合枚举第二个凸多边形的各边的法线，就可以按老方法进行检测和分离了。 至于圆投影到投影轴上，只需要作原点到圆心的向量，将该向量投影到投影轴上然后加减半径就好了。 ![投影3](http://ot1c7ttzm.bkt.clouddn.com/sat5.png)

# **完整实现代码**

[碰撞检测完整实现(两凸多边形版和圆形凸多边形版)](https://gist.github.com/zedom1/8c5aa61a92e6c077307586303f30f0c6)

- ​